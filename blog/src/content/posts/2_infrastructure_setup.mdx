---
number: 2
title: "Infrastructure Setup"
date: "Dec 10, 2025"
excerpt: "How I deployed CCPP on an Ionos server using Docker Compose, Traefik, Kafka, Watchtower, and Spring Boot image builds."
topics: [DevOps]
color: "#10b981"
---

import Mermaid from '../../components/Mermaid.astro';

# Infrastructure Setup on Ionos

This page describes the full deployment setup I use on my Ionos VPS.
It’s based on **Traefik**, **Docker Compose**, **Kafka (KRaft)**, **Spring Boot image-build**, and **Watchtower** for automated updates.

Everything runs inside a single network called `ccpp-network`.

---

# Docker Compose

Below is the full Compose file, including Traefik labels, Kafka, microservices, and Watchtower.

```yaml
services:

  api-gateway:
    image: ghcr.io/jbonifay/api-gateway:latest
    container_name: api-gateway
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-gateway.rule=Host(`ccpp.joffreybonifay.fr`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api-gateway.entrypoints=websecure"
      - "traefik.http.routers.api-gateway.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api-gateway.priority=10"
      - "traefik.http.middlewares.api-stripprefix.stripprefix.prefixes=/api"
      - "traefik.http.routers.api-gateway.middlewares=api-stripprefix"
      - "traefik.http.services.api-gateway.loadbalancer.server.port=8761"
    depends_on:
      - kafka
    networks:
      - ccpp-network

  # Microservices
  project-planning:
    image: ghcr.io/jbonifay/project-planning:latest
    container_name: project-planning
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - kafka
    networks:
      - ccpp-network

  workspace:
    image: ghcr.io/jbonifay/workspace:latest
    container_name: workspace
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - kafka
    networks:
      - ccpp-network

  ideation:
    image: ghcr.io/jbonifay/ideation:latest
    container_name: ideation
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - kafka
    networks:
      - ccpp-network

  notification:
    image: ghcr.io/jbonifay/notification:latest
    container_name: notification
    environment:
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - kafka
    networks:
      - ccpp-network

  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_LISTENERS: "PLAINTEXT://kafka:9092,CONTROLLER://kafka:9093"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_LOG_DIRS: "/tmp/kraft-combined-logs"
    networks:
      - ccpp-network

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_DEBUG=false
      - WATCHTOWER_POLL_INTERVAL=3600 # every hour
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - ccpp-network

networks:
  ccpp-network:
    driver: bridge
```
## Infrastructure Schema

Below is the architecture diagram representing Traefik, the Gateway, Kafka, and the microservices.

<Mermaid code={`flowchart TD

    subgraph Traefik [Traefik Reverse Proxy]
        A[ccpp.joffreybonifay.fr] -->|/api| APIGW
    end

    subgraph Gateway [API Gateway 8761]
        APIGW
    end

    subgraph KafkaCluster [Kafka KRaft]
        K[Kafka Broker]
    end

    APIGW --> K

    subgraph Services [Microservices]
        PP[Project Planning]
        WS[Workspace]
        ID[Ideation]
        NT[Notification]
    end

    K --> PP
    K --> WS
    K --> ID
    K --> NT

    subgraph Watchtower [Auto Update]
        WT[Watchtower]
    end

    WT --> APIGW
    WT --> PP
    WT --> WS
    WT --> ID
    WT --> NT
    WT --> K
`} />

### Watchtower: Auto-Update Strategy

Watchtower automatically:

- Pulls new images from GitHub Container Registry
- Restarts services with zero manual intervention
- Cleans old images

You can adjust:

- `WATCHTOWER_POLL_INTERVAL`
- Add scoped update rules (e.g., only update certain services)
- Use notifications (Slack, Discord, email…)
